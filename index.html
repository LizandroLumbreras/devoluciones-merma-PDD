<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Devoluciones ‚Äì PROVSOFT</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#f5f6f8;
    --ink:#111;
    --muted:#6b7280;
    --brand:#131921;     /* estilo Amazon */
    --brand2:#232f3e;
    --primary:#3483fa;   /* estilo ML */
    --primary2:#2968c8;
    --card:#fff;
    --line:#e7e9ee;
    --shadow:0 2px 10px rgba(0,0,0,.08);
    --r:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg);
    color:var(--ink);
  }

  /* TOP BAR */
  .topbar{
    background:var(--brand);
    color:#fff;
    padding:14px 16px;
  }
  .topbar-inner{
    max-width:1200px;
    margin:auto;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{
    display:flex;
    gap:10px;
    align-items:center;
    font-weight:800;
    letter-spacing:.3px;
    font-size:16px;
    white-space:nowrap;
  }
  .brand-badge{
    background:var(--primary);
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:800;
  }
  .pill{
    background:var(--brand2);
    border:1px solid rgba(255,255,255,.12);
    padding:8px 10px;
    border-radius:999px;
    font-size:12px;
    white-space:nowrap;
    max-width:60vw;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* PAGE */
  .page{
    max-width:1200px;
    margin:auto;
    padding:18px 14px 26px 14px;
    display:grid;
    gap:14px;
  }

  /* STEPS */
  .steps{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .chip{
    background:#fff;
    border:1px solid var(--line);
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    color:var(--muted);
    box-shadow:0 1px 6px rgba(0,0,0,.04);
  }
  .chip.on{
    color:#0b2a55;
    border-color:rgba(52,131,250,.35);
    background:rgba(52,131,250,.10);
    font-weight:700;
  }

  /* CARD */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card-hd{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .card-hd h2{
    margin:0;
    font-size:16px;
    font-weight:800;
    letter-spacing:.1px;
  }
  .card-bd{ padding:16px; }

  /* FORMS */
  label{display:block;font-size:12px;color:#111;font-weight:700;margin-bottom:6px}
  input, textarea{
    width:100%;
    padding:12px 12px;
    border-radius:10px;
    border:1px solid #d7dae2;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  input:focus, textarea:focus{ border-color:rgba(52,131,250,.8); box-shadow:0 0 0 3px rgba(52,131,250,.15); }
  textarea{min-height:72px; resize:vertical}

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media(max-width:820px){ .grid2{grid-template-columns:1fr} }

  /* BUTTONS */
  .btn{
    border:0;
    border-radius:10px;
    padding:12px 14px;
    font-weight:800;
    font-size:13px;
    cursor:pointer;
    transition:.15s;
    white-space:nowrap;
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-primary:hover{ background:var(--primary2); }
  .btn-soft{
    background:#fff;
    color:#0b2a55;
    border:1px solid var(--line);
  }
  .btn-soft:hover{ background:#f9fafb }
  .btn-danger{ background:#e53935; color:#fff; }
  .btn-ok{ background:#1e8e3e; color:#fff; }

  .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
    margin-top:12px;
  }

  /* SEARCH */
  .searchbar{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
  }
  @media(max-width:520px){ .searchbar{grid-template-columns:1fr} }

  .hint{ color:var(--muted); font-size:12px; line-height:1.35; margin-top:8px; }
  .msg{
    margin-top:10px;
    padding:10px 12px;
    border-radius:10px;
    font-size:13px;
    display:none;
    border:1px solid transparent;
  }
  .msg.ok{display:block;background:rgba(30,142,62,.10);border-color:rgba(30,142,62,.22);color:#0b5a1e}
  .msg.bad{display:block;background:rgba(229,57,53,.10);border-color:rgba(229,57,53,.22);color:#7a1414}
  .msg.info{display:block;background:rgba(52,131,250,.10);border-color:rgba(52,131,250,.22);color:#0a3b6f}

  /* RESULTS GRID */
  .results{
    margin-top:14px;
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
    gap:12px;
  }
  .pCard{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:120px;
  }
  .pTop{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .code{
    font-weight:900;
    font-size:13px;
    color:#0b2a55;
    word-break:break-word;
  }
  .desc{
    font-size:13px;
    color:#111;
    line-height:1.25;
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }

  /* TABLE CONTROLLED */
  .tableWrap{
    border:1px solid var(--line);
    border-radius:12px;
    overflow:auto;
    max-height:380px;
    background:#fff;
  }
  table{ width:100%; border-collapse:collapse; min-width:760px; }
  th, td{
    padding:10px;
    font-size:13px;
    border-bottom:1px solid var(--line);
    vertical-align:top;
  }
  th{
    background:#f7f8fb;
    position:sticky;
    top:0;
    z-index:1;
    text-align:left;
    color:#0b2a55;
  }
  td.small{ color:var(--muted); font-size:12px }
  .tdDesc{
    max-width:420px;
    white-space:normal;
    word-break:break-word;
  }

  /* SIGNATURE */
  .sigWrap{
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    max-width:720px;
    background:#fff;
  }
  canvas{ display:block; width:100%; height:auto; background:#fff; }

  .hidden{ display:none !important; }
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">PROVSOFT <span class="brand-badge">DEV</span></div>
      <div class="pill" id="pillUser">No autenticado</div>
    </div>
  </div>

  <div class="page">

    <div class="steps" id="chips">
      <div class="chip on" data-step="login">1) Login</div>
      <div class="chip" data-step="buscar">2) Buscar</div>
      <div class="chip" data-step="tabla">3) Tabla</div>
      <div class="chip" data-step="resumen">4) Resumen</div>
      <div class="chip" data-step="firma">5) Firma</div>
    </div>

    <!-- LOGIN -->
    <section class="card" id="step-login">
      <div class="card-hd">
        <h2>Acceso</h2>
        <button class="btn btn-soft hidden" id="btnSalir">Salir</button>
      </div>
      <div class="card-bd">
        <div class="grid2" style="max-width:520px;margin:auto">
          <div>
            <label>Usuario</label>
            <input id="inUsuario" placeholder="Ej: JENARO" autocomplete="username">
          </div>
          <div>
            <label>Contrase√±a</label>
            <input id="inPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          </div>
        </div>

        <div class="hint" style="max-width:520px;margin:10px auto 0">
          Inicio de sesi√≥n contra <b>Firestore/usuarios_ruta</b> (usuario, password, activo).
        </div>

        <div class="actions" style="max-width:520px;margin:14px auto 0">
          <button class="btn btn-primary" id="btnLogin">Entrar</button>
        </div>

        <div class="msg" id="msgLogin"></div>
      </div>
    </section>

    <!-- BUSCAR -->
    <section class="card hidden" id="step-buscar">
      <div class="card-hd">
        <h2>Buscar productos</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-soft" id="btnIrTabla">Ver tabla</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="searchbar">
          <input id="inBuscar" placeholder="Buscar por c√≥digo de barras o por descripci√≥n (concepto)">
          <button class="btn btn-primary" id="btnBuscar">Buscar</button>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Ruta / Sucursal</label>
            <input id="inSucursal" disabled>
          </div>
          <div>
            <label>Fecha</label>
            <input id="inFecha" disabled>
          </div>
        </div>

        <div class="hint">
          Busca en <b>productos</b> usando <b>codigoBarra</b> y <b>concepto</b>.
        </div>

        <div class="msg" id="msgBuscar"></div>

        <div class="results" id="resultados"></div>
      </div>
    </section>

    <!-- TABLA -->
    <section class="card hidden" id="step-tabla">
      <div class="card-hd">
        <h2>Productos a devolver</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-soft" id="btnVolverBuscar">Volver</button>
          <button class="btn btn-ok" id="btnContinuar">Continuar</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:140px">C√≥digo</th>
                <th>Descripci√≥n</th>
                <th style="width:90px">Cant.</th>
                <th style="width:180px">Motivo</th>
                <th style="width:100px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbodyDev"></tbody>
          </table>
        </div>

        <div class="hint" id="totalesInfo">0 productos</div>
        <div class="msg" id="msgTabla"></div>
      </div>
    </section>

    <!-- RESUMEN -->
    <section class="card hidden" id="step-resumen">
      <div class="card-hd">
        <h2>Resumen de devoluci√≥n</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-soft" id="btnBackTabla">Regresar</button>
          <button class="btn btn-ok" id="btnFinalizar">Finalizar</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="grid2">
          <div>
            <label>Usuario</label>
            <input id="outUsuario" disabled>
          </div>
          <div>
            <label>Ruta / Sucursal</label>
            <input id="outSucursal" disabled>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Fecha</label>
            <input id="outFecha" disabled>
          </div>
          <div>
            <label>Notas (opcional)</label>
            <input id="outNotas" placeholder="Ej: merma, caducidad, error de surtido...">
          </div>
        </div>

        <div class="tableWrap" style="margin-top:12px;max-height:320px">
          <table>
            <thead>
              <tr>
                <th style="width:140px">C√≥digo</th>
                <th>Descripci√≥n</th>
                <th style="width:90px">Cant.</th>
                <th style="width:180px">Motivo</th>
              </tr>
            </thead>
            <tbody id="tbodyResumen"></tbody>
          </table>
        </div>

        <div class="msg" id="msgResumen"></div>
      </div>
    </section>

    <!-- FIRMA -->
    <section class="card hidden" id="step-firma">
      <div class="card-hd">
        <h2>Firma</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-soft" id="btnBackResumen">Regresar</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="hint">Firma dentro del recuadro (mouse o touch). Luego guarda: se registra en Firebase y se descarga el PDF.</div>

        <div style="margin-top:12px">
          <div class="sigWrap">
            <canvas id="firmaCanvas" width="1000" height="360"></canvas>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-soft" id="btnLimpiarFirma">Limpiar</button>
          <button class="btn btn-ok" id="btnGuardar">Guardar y descargar PDF</button>
        </div>

        <div class="msg" id="msgFirma"></div>
      </div>
    </section>

  </div>

<script type="module">
  // ==========================================================
  // Firebase (MODULAR)
  // ==========================================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  runTransaction,
  query,
  where,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.firebasestorage.app",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ==========================================================
  // CONFIG (TU MODELO REAL)
  // ==========================================================
  const CONFIG = {
    usuariosCollection: "usuarios_ruta",
    productosCollection: "productos",
    productosCampoCodigo: "codigoBarra",
    productosCampoDescPreferido: "concepto",
    devolucionesCollection: "devoluciones"
  };

  // ==========================================================
  // Estado
  // ==========================================================
  let usuarioActual = null;
  let usuarioDocId = null;

  let productosCache = [];
  let devolucionItems = [];

  // ==========================================================
  // DOM
  // ==========================================================
  const $ = (id)=>document.getElementById(id);

  const steps = ["login","buscar","tabla","resumen","firma"];
  const stepEls = Object.fromEntries(steps.map(s=>[s, $("step-"+s)]));

  function setChip(step){
    document.querySelectorAll(".chip").forEach(c=>{
      c.classList.toggle("on", c.dataset.step === step);
    });
  }
  function showStep(step){
    steps.forEach(s=>stepEls[s].classList.toggle("hidden", s!==step));
    setChip(step);
  }

  function setMsg(el, type, text){
    el.className = "msg " + (type || "");
    el.textContent = text || "";
    el.style.display = text ? "block" : "none";
  }

  function nowStr(){ return new Date().toLocaleString("es-MX"); }
  function norm(s){
    return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  }
  function safeInt(x){
    const n = Number(x);
    return Number.isFinite(n) ? Math.floor(n) : 0;
  }
async function obtenerFolioDevolucion() {
  const ref = doc(db, "consecutivos", "devoluciones");

  return await runTransaction(db, async (tx) => {
    const snap = await tx.get(ref);
    let ultimo = 0;

    if (snap.exists()) {
      ultimo = snap.data().ultimo || 0;
    }

    const nuevo = ultimo + 1;

    tx.set(ref, { ultimo: nuevo }, { merge: true });

    // üî• FOLIO A 5 D√çGITOS
    return String(nuevo).padStart(5, "0");
  });
}

  // ==========================================================
  // UI refs
  // ==========================================================
  const pillUser = $("pillUser");
  const btnSalir = $("btnSalir");

  const msgLogin = $("msgLogin");
  const msgBuscar = $("msgBuscar");
  const msgTabla = $("msgTabla");
  const msgResumen = $("msgResumen");
  const msgFirma = $("msgFirma");

  // ==========================================================
  // Login (Firestore usuarios_ruta)
  // ==========================================================
  $("btnLogin").addEventListener("click", loginRuta);
  $("inPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginRuta(); });

  async function loginRuta(){
    setMsg(msgLogin, "info", "Validando usuario...");
    const u = ($("inUsuario").value||"").trim().toUpperCase();
    const p = ($("inPass").value||"").trim();

    if(!u || !p){
      setMsg(msgLogin, "bad", "Ingresa usuario y contrase√±a.");
      return;
    }

    try{
      const qU = query(
        collection(db, CONFIG.usuariosCollection),
        where("usuario","==", u),
        where("password","==", p),
        where("activo","==", true)
      );
      const snap = await getDocs(qU);
      if(snap.empty){
        setMsg(msgLogin, "bad", "Usuario/contrase√±a incorrectos o usuario inactivo.");
        return;
      }

      const d = snap.docs[0];
      usuarioDocId = d.id;
      usuarioActual = d.data();

      pillUser.textContent = `${usuarioActual.nombre || usuarioActual.usuario} ‚Ä¢ ${usuarioActual.rutaId || "SIN RUTA"}`;
      btnSalir.classList.remove("hidden");

      $("inSucursal").value = usuarioActual.rutaId || "";
      $("inFecha").value = nowStr();

      setMsg(msgLogin, "ok", "Acceso correcto. Cargando productos...");
      await precargarProductos();

      showStep("buscar");
      setMsg(msgLogin, "", "");
    }catch(err){
      console.error(err);
      setMsg(msgLogin, "bad", "Error al validar. Revisa consola.");
    }
  }

  btnSalir.addEventListener("click", ()=>{
    usuarioActual = null;
    usuarioDocId = null;
    productosCache = [];
    devolucionItems = [];
    renderTabla();

    pillUser.textContent = "No autenticado";
    btnSalir.classList.add("hidden");
    $("inUsuario").value = "";
    $("inPass").value = "";

    $("inBuscar").value = "";
    $("resultados").innerHTML = "";
    setMsg(msgBuscar,"","");
    setMsg(msgTabla,"","");
    setMsg(msgResumen,"","");
    setMsg(msgFirma,"","");
    limpiarFirma();

    showStep("login");
  });
  // ==========================================================
  // Cargar productos (productos: codigoBarra + concepto)
  // ==========================================================
async function precargarProductos(){
  setMsg(msgBuscar, "info", "Cargando cat√°logo de productos activos...");
  productosCache = [];

  try{
    const q = query(
      collection(db, CONFIG.productosCollection),
      where("activo", "==", true) // üî• SOLO ACTIVOS
    );

    const snap = await getDocs(q);

    snap.forEach(docu=>{
      const p = docu.data();

      const codigo = (p.codigoBarra || p.codigobarras || p.codigo || "")
        .toString()
        .trim();

      const descripcion =
        p.concepto ??
        p.nombre ??
        p.descripcion ??
        p.descripcionProducto ??
        "(sin descripci√≥n)";

      // seguridad extra
      if(!codigo || descripcion === "(sin descripci√≥n)") return;

      productosCache.push({
        id: docu.id,
        codigo,
        descripcion
      });
    });

    setMsg(
      msgBuscar,
      "ok",
      `Productos activos cargados: ${productosCache.length}`
    );
  }catch(err){
    console.error(err);
    setMsg(
      msgBuscar,
      "bad",
      "Error cargando productos activos."
    );
  }
}

  // ==========================================================
  // Buscar
  // ==========================================================
  $("btnBuscar").addEventListener("click", buscar);
  $("inBuscar").addEventListener("keydown", (e)=>{ if(e.key==="Enter") buscar(); });

  function buscar(){
    const txt = ($("inBuscar").value||"").trim();
    const out = $("resultados");
    out.innerHTML = "";

    if(!txt){
      setMsg(msgBuscar, "bad", "Escribe un c√≥digo o palabra.");
      return;
    }

    const t = norm(txt);
    const hits = productosCache.filter(p=>{
      return norm(p.codigo).includes(t) || norm(p.descripcion).includes(t);
    }).slice(0, 60);

    if(!hits.length){
      setMsg(msgBuscar, "bad", "Sin resultados.");
      return;
    }

    setMsg(msgBuscar, "ok", `Resultados: ${hits.length} (m√°x. 60).`);

    hits.forEach(p=>{
      const div = document.createElement("div");
      div.className = "pCard";
      div.innerHTML = `
        <div class="pTop">
          <div>
            <div class="code">${escapeHtml(p.codigo || "(sin c√≥digo)")}</div>
            <div class="desc" title="${escapeHtml(p.descripcion)}">${escapeHtml(p.descripcion)}</div>
          </div>
        </div>
        <div class="actions" style="margin-top:auto">
          <button class="btn btn-primary" data-add>Agregar</button>
        </div>
      `;
      div.querySelector("[data-add]").addEventListener("click", ()=>agregarProducto(p));
      out.appendChild(div);
    });
  }

  // ==========================================================
  // Tabla: agregar / render / quitar
  // ==========================================================
  function agregarProducto(p){
    const cantStr = prompt(`Cantidad a devolver\n\n${p.codigo} - ${p.descripcion}`, "1");
    if(cantStr === null) return;

    const cant = safeInt(cantStr);
    if(!(cant > 0)){
      alert("Cantidad inv√°lida.");
      return;
    }

    const motivo = prompt("Motivo (MERMA / CADUCIDAD / ERROR / OTRO)", "MERMA");
    if(motivo === null) return;

    devolucionItems.push({
      codigo: p.codigo,
      descripcion: p.descripcion,
      cantidad: cant,
      motivo: (motivo || "").trim() || "SIN MOTIVO"
    });

    renderTabla();
    showStep("tabla");
    setMsg(msgTabla, "ok", "Producto agregado.");
    setTimeout(()=>setMsg(msgTabla,"",""), 900);
  }

  function renderTabla(){
    const tb = $("tbodyDev");
    tb.innerHTML = "";

    if(!devolucionItems.length){
      tb.innerHTML = `<tr><td colspan="5" class="small">Sin productos agregados.</td></tr>`;
      $("totalesInfo").textContent = "0 productos";
      return;
    }

    devolucionItems.forEach((p, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.codigo)}</td>
        <td class="tdDesc">${escapeHtml(p.descripcion)}</td>
        <td><b>${p.cantidad}</b></td>
        <td>${escapeHtml(p.motivo)}</td>
        <td><button class="btn btn-danger" style="padding:8px 10px;border-radius:10px;font-size:12px" data-del>Quitar</button></td>
      `;
      tr.querySelector("[data-del]").addEventListener("click", ()=>{
        devolucionItems.splice(idx,1);
        renderTabla();
      });
      tb.appendChild(tr);
    });

    const totalItems = devolucionItems.length;
    const totalCant = devolucionItems.reduce((acc,p)=>acc + safeInt(p.cantidad),0);
    $("totalesInfo").textContent = `${totalItems} productos ‚Ä¢ ${totalCant} piezas`;
  }
  // ==========================================================
  // Resumen
  // ==========================================================
  $("btnContinuar").addEventListener("click", ()=>{
    if(!devolucionItems.length){
      setMsg(msgTabla, "bad", "Agrega al menos 1 producto.");
      return;
    }
    setMsg(msgTabla, "", "");

    $("outUsuario").value = usuarioActual?.nombre || usuarioActual?.usuario || "";
    $("outSucursal").value = usuarioActual?.rutaId || "";
    $("outFecha").value = nowStr();

    const tb = $("tbodyResumen");
    tb.innerHTML = "";
    devolucionItems.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.codigo)}</td>
        <td class="tdDesc">${escapeHtml(p.descripcion)}</td>
        <td><b>${p.cantidad}</b></td>
        <td>${escapeHtml(p.motivo)}</td>
      `;
      tb.appendChild(tr);
    });

    showStep("resumen");
  });

  $("btnBackTabla").addEventListener("click", ()=>showStep("tabla"));
  $("btnFinalizar").addEventListener("click", ()=>showStep("firma"));
  $("btnBackResumen").addEventListener("click", ()=>showStep("resumen"));

  // ==========================================================
  // Firma (canvas) mouse + touch (sin desborde)
  // ==========================================================
  const canvas = $("firmaCanvas");
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111";

  let drawing = false;
  let last = null;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    let x, y;

    if(e.touches && e.touches.length){
      x = e.touches[0].clientX - rect.left;
      y = e.touches[0].clientY - rect.top;
    }else{
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }

    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return { x: x*scaleX, y: y*scaleY };
  }

  function startDraw(e){
    drawing = true;
    last = getPos(e);
    e.preventDefault?.();
  }
  function moveDraw(e){
    if(!drawing) return;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
    e.preventDefault?.();
  }
  function endDraw(e){
    drawing = false;
    last = null;
    e.preventDefault?.();
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", moveDraw);
  window.addEventListener("mouseup", endDraw);

  canvas.addEventListener("touchstart", startDraw, {passive:false});
  canvas.addEventListener("touchmove", moveDraw, {passive:false});
  window.addEventListener("touchend", endDraw, {passive:false});

  $("btnLimpiarFirma").addEventListener("click", ()=>{
    limpiarFirma();
    setMsg(msgFirma, "info", "Firma limpiada.");
    setTimeout(()=>setMsg(msgFirma,"",""), 700);
  });

  function limpiarFirma(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function firmaVacia(){
    const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    for(let i=3;i<pixels.length;i+=4){
      if(pixels[i] !== 0) return false;
    }
    return true;
  }

  // ==========================================================
  // Guardar + PDF "bonito" (corporativo y sin cortes)
  // ==========================================================
  $("btnGuardar").addEventListener("click", async ()=>{
    if(!usuarioActual || !usuarioDocId){
      setMsg(msgFirma, "bad", "Sin sesi√≥n activa.");
      showStep("login");
      return;
    }
    if(!devolucionItems.length){
      setMsg(msgFirma, "bad", "No hay productos.");
      return;
    }
    if(firmaVacia()){
      setMsg(msgFirma, "bad", "La firma est√° vac√≠a.");
      return;
    }

    $("btnGuardar").disabled = true;
    setMsg(msgFirma, "info", "Guardando devoluci√≥n en Firebase...");

    try{
      const firmaBase64 = canvas.toDataURL("image/png");

const payload = {
  estado: "pendiente", // üëà estado inicial correcto
  usuarioRutaDocId: usuarioDocId,
  usuario: usuarioActual.usuario || "",
  nombre: usuarioActual.nombre || "",
  rol: usuarioActual.rol || "",
  rutaId: usuarioActual.rutaId || "",

  fechaISO: new Date().toISOString(),
  fecha: serverTimestamp(),
  notas: ($("outNotas").value || "").trim(),

  productos: devolucionItems.map(p=>({
    codigo: p.codigo,
    descripcion: p.descripcion,
    cantidad: safeInt(p.cantidad),
    motivo: p.motivo
  })),

  firmaBase64
};


// ‚úÖ OBTENER FOLIO NUM√âRICO
const folio = await obtenerFolioDevolucion();

// AGREGAR FOLIO AL PAYLOAD
payload.folio = folio;

// GUARDAR DEVOLUCI√ìN
await addDoc(collection(db, "devoluciones"), payload);


      const pdfBlob = await generarPDFBonito({ folio, payload });
      descargarBlob(pdfBlob, `devolucion_${folio}.pdf`);

      setMsg(msgFirma, "ok", `Guardado OK. Folio: ${folio}. PDF descargado.`);
    }catch(err){
      console.error(err);
      setMsg(msgFirma, "bad", "Error al guardar o generar PDF. Revisa consola.");
    }finally{
      $("btnGuardar").disabled = false;
    }
  });

  async function generarPDFBonito({ folio, payload }) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "letter" });

    const pageW = doc.internal.pageSize.width;
    const pageH = doc.internal.pageSize.height;
    const margin = 40;
    let y = 0;

    // HEADER (corporativo)
    doc.setFillColor(19, 25, 33); // tipo Amazon
    doc.rect(0, 0, pageW, 90, "F");

    doc.setFont("helvetica","bold");
    doc.setTextColor(255);
    doc.setFontSize(18);
    doc.text("PROVSOFT", margin, 40);

    doc.setFontSize(12);
    doc.text("FORMATO DE DEVOLUCI√ìN", margin, 62);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Folio: ${folio}`, pageW - margin, 40, { align:"right" });
    doc.text(new Date(payload.fechaISO).toLocaleString("es-MX"), pageW - margin, 58, { align:"right" });

    y = 110;
    doc.setTextColor(0);

    // Tarjeta info
    doc.setDrawColor(220);
    doc.setFillColor(245, 247, 250);
    doc.roundedRect(margin, y, pageW - margin*2, 70, 8, 8, "FD");

    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.text("Usuario:", margin + 12, y + 24);
    doc.text("Ruta / Sucursal:", pageW/2, y + 24);

    doc.setFont("helvetica","normal");
    doc.text((payload.nombre || ""), margin + 80, y + 24);
    doc.text((payload.rutaId || ""), pageW/2 + 110, y + 24);

    doc.text(`Rol: ${payload.rol || ""}`, margin + 12, y + 48);

    y += 100;

    if(payload.notas){
      doc.setFont("helvetica","bold");
      doc.text("Notas:", margin, y);
      doc.setFont("helvetica","normal");
      const notasLines = doc.splitTextToSize(payload.notas, pageW - margin*2);
      doc.text(notasLines, margin + 50, y);
      y += notasLines.length * 14 + 10;
    }

    // T√≠tulo tabla
    doc.setFont("helvetica","bold");
    doc.setFontSize(13);
    doc.text("Productos devueltos", margin, y);
    y += 16;

    // Header tabla
    doc.setFillColor(230, 235, 240);
    doc.rect(margin, y, pageW - margin*2, 26, "F");

    const col = {
      codigo: margin + 8,
      desc: margin + 90,
      cant: pageW - margin - 150,
      motivo: pageW - margin - 70
    };
    const wDesc = (col.cant - col.desc - 10);
    const wMot = 90;

    doc.setFontSize(10);
    doc.text("C√≥digo", col.codigo, y + 18);
    doc.text("Descripci√≥n", col.desc, y + 18);
    doc.text("Cant.", col.cant, y + 18);
    doc.text("Motivo", col.motivo, y + 18);

    y += 34;
    doc.setFont("helvetica","normal");

    // Filas
    for(const p of payload.productos){
      const descLines = doc.splitTextToSize((p.descripcion||""), wDesc);
      const motivoLines = doc.splitTextToSize((p.motivo||""), wMot);
      const rowH = Math.max(descLines.length, motivoLines.length) * 14;

      if(y + rowH > pageH - 180){
        doc.addPage();
        y = margin;
      }

      doc.text(String(p.codigo||""), col.codigo, y);
      doc.text(descLines, col.desc, y);
      doc.text(String(p.cantidad||0), col.cant, y);
      doc.text(motivoLines, col.motivo, y);

      y += rowH + 8;
      doc.setDrawColor(235);
      doc.line(margin, y - 4, pageW - margin, y - 4);
    }

    // Firma
    if(y > pageH - 200){
      doc.addPage();
      y = margin;
    }

    y += 18;
    doc.setFont("helvetica","bold");
    doc.text("Firma de conformidad", margin, y);

    y += 10;
    doc.roundedRect(margin, y, 300, 120, 8, 8);
    doc.addImage(payload.firmaBase64, "PNG", margin + 10, y + 10, 280, 100);

    // Footer
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text("Documento generado autom√°ticamente por PROVSOFT", pageW/2, pageH - 30, { align:"center" });

    return doc.output("blob");
  }

  function descargarBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ==========================================================
  // Navegaci√≥n
  // ==========================================================
  $("btnIrTabla").addEventListener("click", ()=>showStep("tabla"));
  $("btnVolverBuscar").addEventListener("click", ()=>showStep("buscar"));

  // Init
  showStep("login");
  renderTabla();
</script>
</body>
</html>
