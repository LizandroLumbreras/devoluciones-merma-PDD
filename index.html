<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formato de Devoluci√≥n ‚Äì PROVSOFT</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --azul:#00416A;
      --azul2:#0c6cbd;
      --card:#ffffff;
      --muted:#6b7280;
      --ok:#1e8e3e;
      --bad:#c62828;
      --shadow:0 8px 24px rgba(0,0,0,.10);
      --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins,system-ui,Segoe UI,Arial;
      background: linear-gradient(135deg, var(--azul), var(--azul2));
      min-height:100vh;
      color:#111;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;color:#fff;padding:10px 2px 16px}
    .topbar h1{font-size:18px;margin:0;font-weight:600}
    .topbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      max-width:520px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .btn{
      border:0;background:var(--azul);color:#fff;
      padding:10px 14px;border-radius:10px;cursor:pointer;
      box-shadow:0 4px 14px rgba(0,0,0,.18);font-weight:600;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.sec{background:#fff;color:var(--azul);border:1px solid rgba(0,0,0,.10);box-shadow:none}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}
    .mini{padding:7px 10px;border-radius:10px;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      background: linear-gradient(135deg, rgba(0,65,106,.10), rgba(12,108,189,.08));
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .card .hd h2{margin:0;font-size:16px;color:var(--azul)}
    .card .bd{padding:16px}
    label{display:block;font-size:12px;color:#111;margin-bottom:6px;font-weight:600}
    input, textarea{
      width:100%;padding:10px 12px;border:1px solid rgba(0,0,0,.15);
      border-radius:10px;outline:none;font-size:14px;background:#fff;
    }
    input:focus, textarea:focus{border-color:rgba(12,108,189,.6)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.row{grid-template-columns:1fr}}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .msg{margin-top:10px;padding:10px 12px;border-radius:10px;font-size:13px;display:none}
    .msg.ok{background:rgba(30,142,62,.12);color:#0b5a1e;border:1px solid rgba(30,142,62,.25);display:block}
    .msg.bad{background:rgba(198,40,40,.12);color:#7a1414;border:1px solid rgba(198,40,40,.25);display:block}
    .msg.info{background:rgba(12,108,189,.10);color:#0a3b6f;border:1px solid rgba(12,108,189,.18);display:block}
    .steps{display:flex;gap:8px;flex-wrap:wrap;padding:0 0 14px}
    .stepchip{
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.20);
      color:#fff;padding:8px 10px;border-radius:999px;font-size:12px;opacity:.7;
    }
    .stepchip.active{opacity:1;background:rgba(255,255,255,.20)}
    .split{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px 10px;font-size:13px;vertical-align:top}
    th{background:rgba(0,65,106,.08);color:var(--azul);text-align:left}
    .t-actions{white-space:nowrap}
    .searchGrid{display:grid;grid-template-columns:1.2fr 1fr 1fr auto;gap:10px;align-items:end}
    @media(max-width:980px){.searchGrid{grid-template-columns:1fr}}
    .results{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:820px){.results{grid-template-columns:1fr}}
    .resItem{
      background:#fff;border:1px solid rgba(0,0,0,.10);border-radius:12px;padding:10px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .resItem b{display:block;color:#111;font-size:13px}
    .resItem span{display:block;color:var(--muted);font-size:12px;margin-top:3px}
    .canvasWrap{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;overflow:hidden;width:100%;max-width:650px}
    canvas{display:block;width:100%;height:auto;background:#fff}
    .footActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Formato de Devoluci√≥n</h1>
      <div class="right">
        <div class="pill" id="pillUser">No autenticado</div>
        <button class="btn sec mini" id="btnSalir" hidden>Salir</button>
      </div>
    </div>

    <div class="steps">
      <div class="stepchip active" data-step="login">1) Login</div>
      <div class="stepchip" data-step="buscar">2) Buscar</div>
      <div class="stepchip" data-step="tabla">3) Tabla</div>
      <div class="stepchip" data-step="resumen">4) Resumen</div>
      <div class="stepchip" data-step="firma">5) Firma</div>
    </div>

    <div class="grid">

      <!-- STEP 1: LOGIN (FIRESTORE usuarios_ruta) -->
      <section class="card" id="step-login">
        <div class="hd">
          <h2>1) Acceso</h2>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Usuario</label>
              <input id="inUsuario" placeholder="Ej: JENARO" autocomplete="username"/>
            </div>
            <div>
              <label>Contrase√±a</label>
              <input id="inPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
            </div>
          </div>

          <div class="hint">
            Login directo contra <b>Firestore/usuarios_ruta</b> usando campos: <b>usuario</b>, <b>password</b>, <b>activo</b>.
          </div>

          <div class="footActions">
            <button class="btn" id="btnLogin">Entrar</button>
          </div>

          <div class="msg" id="msgLogin"></div>
        </div>
      </section>

      <!-- STEP 2: BUSCADOR -->
      <section class="card" id="step-buscar" hidden>
        <div class="hd">
          <h2>2) Buscar productos</h2>
          <div class="split">
            <button class="btn sec mini" id="btnIrTabla">Ver tabla</button>
          </div>
        </div>
        <div class="bd">
          <div class="searchGrid">
            <div>
              <label>B√∫squeda (c√≥digo o palabra)</label>
              <input id="inBuscar" placeholder="Ej: 750... o VASO o BOLSA..." />
            </div>
            <div>
              <label>Ruta / Sucursal</label>
              <input id="inSucursal" disabled />
            </div>
            <div>
              <label>Fecha</label>
              <input id="inFecha" disabled />
            </div>
            <div>
              <button class="btn" id="btnBuscar">Buscar</button>
            </div>
          </div>

          <div class="hint">
            Esta demo carga productos activos desde Firestore y filtra en memoria.
            Si tu colecci√≥n/campos son distintos, ajusta los nombres en la secci√≥n <b>CONFIG</b> del JS.
          </div>

          <div class="msg" id="msgBuscar"></div>
          <div class="results" id="resultados"></div>
        </div>
      </section>

      <!-- STEP 3: TABLA -->
      <section class="card" id="step-tabla" hidden>
        <div class="hd">
          <h2>3) Tabla de devoluci√≥n</h2>
          <div class="split">
            <button class="btn sec mini" id="btnVolverBuscar">Volver</button>
            <button class="btn ok mini" id="btnContinuar">Continuar</button>
          </div>
        </div>
        <div class="bd">
          <table>
            <thead>
              <tr>
                <th style="width:120px">C√≥digo</th>
                <th>Descripci√≥n</th>
                <th style="width:110px">Cantidad</th>
                <th style="width:210px">Motivo</th>
                <th class="t-actions" style="width:90px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbodyDev"></tbody>
          </table>

          <div class="hint small" id="totalesInfo">0 productos</div>
          <div class="msg" id="msgTabla"></div>
        </div>
      </section>

      <!-- STEP 4: RESUMEN -->
      <section class="card" id="step-resumen" hidden>
        <div class="hd">
          <h2>4) Resumen</h2>
          <div class="split">
            <button class="btn sec mini" id="btnBackTabla">Regresar</button>
            <button class="btn ok mini" id="btnFinalizar">Finalizar</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Usuario</label>
              <input id="outUsuario" disabled />
            </div>
            <div>
              <label>Ruta / Sucursal</label>
              <input id="outSucursal" disabled />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Fecha</label>
              <input id="outFecha" disabled />
            </div>
            <div>
              <label>Notas (opcional)</label>
              <input id="outNotas" placeholder="Ej: merma, caducidad, error surtido..." />
            </div>
          </div>

          <div style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th style="width:120px">C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th style="width:110px">Cantidad</th>
                  <th style="width:210px">Motivo</th>
                </tr>
              </thead>
              <tbody id="tbodyResumen"></tbody>
            </table>
          </div>

          <div class="msg" id="msgResumen"></div>
        </div>
      </section>

      <!-- STEP 5: FIRMA -->
      <section class="card" id="step-firma" hidden>
        <div class="hd">
          <h2>5) Firma</h2>
          <div class="split">
            <button class="btn sec mini" id="btnBackResumen">Regresar</button>
          </div>
        </div>
        <div class="bd">
          <div class="hint">Firma dentro del recuadro. Soporta mouse y touch.</div>

          <div style="margin-top:10px">
            <div class="canvasWrap">
              <canvas id="firmaCanvas" width="900" height="350"></canvas>
            </div>
          </div>

          <div class="footActions">
            <button class="btn sec mini" id="btnLimpiarFirma">Limpiar firma</button>
            <button class="btn ok" id="btnGuardar">Guardar y descargar PDF</button>
          </div>

          <div class="msg" id="msgFirma"></div>
        </div>
      </section>

    </div>
  </div>

  <script type="module">
    // ==========================================================
    // ‚úÖ CONFIG (AJUSTA AQU√ç SI TUS NOMBRES CAMBIAN)
    // ==========================================================
    const CONFIG = {
      // Login Firestore:
      usuariosCollection: "usuarios_ruta",  // ‚úÖ tu colecci√≥n real

      // Productos:
      productosCollection: "productos",     // üîß si tu colecci√≥n de productos se llama distinto, c√°mbiala aqu√≠
      productosCampoCodigo: "codigo",       // üîß si usas "codigobarras" cambia aqu√≠
      productosCampoDesc: "descripcion",    // üîß si usas "nombre" cambia aqu√≠
      productosCampoActivo: "activo",       // üîß si no tienes activo, pon null y se traer√°n todos

      // Guardado de devoluciones:
      devolucionesCollection: "devoluciones" // donde se guardar√° el formato
    };

    // ==========================================================
    // Firebase SDK (MODULAR)
    // ==========================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ Tu config
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==========================================================
    // Estado
    // ==========================================================
    let usuarioActual = null;   // data del doc de usuarios_ruta
    let usuarioDocId = null;    // id del documento usuarios_ruta
    let productosCache = [];    // cache de productos
    let devolucionItems = [];   // tabla

    // ==========================================================
    // DOM helpers
    // ==========================================================
    const $ = (id)=>document.getElementById(id);

    const steps = {
      login: $("step-login"),
      buscar: $("step-buscar"),
      tabla: $("step-tabla"),
      resumen: $("step-resumen"),
      firma: $("step-firma"),
    };

    function setMsg(el, type, text){
      el.className = "msg " + (type || "");
      el.textContent = text || "";
      el.style.display = text ? "block" : "none";
    }

    function setActiveChip(stepKey){
      document.querySelectorAll(".stepchip").forEach(ch=>{
        ch.classList.toggle("active", ch.dataset.step === stepKey);
      });
    }

    function showStep(stepKey){
      Object.values(steps).forEach(s=>s.hidden=true);
      steps[stepKey].hidden=false;
      setActiveChip(stepKey);
    }

    function nowStr(){ return new Date().toLocaleString("es-MX"); }

    function norm(s){
      return (s||"").toString().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }

    function safeInt(x){
      const n = Number(x);
      return Number.isFinite(n) ? Math.floor(n) : 0;
    }

    function requireLogin(){
      if(!usuarioActual || !usuarioDocId){
        alert("No hay sesi√≥n. Inicia sesi√≥n.");
        showStep("login");
        return false;
      }
      return true;
    }

    // ==========================================================
    // UI refs
    // ==========================================================
    const pillUser = $("pillUser");
    const btnSalir = $("btnSalir");

    const msgLogin = $("msgLogin");
    const msgBuscar = $("msgBuscar");
    const msgTabla = $("msgTabla");
    const msgResumen = $("msgResumen");
    const msgFirma = $("msgFirma");

    // ==========================================================
    // LOGIN (Firestore usuarios_ruta)
    // ==========================================================
    $("btnLogin").addEventListener("click", loginRuta);

    async function loginRuta(){
      setMsg(msgLogin, "info", "Validando usuario...");

      const usuario = ($("inUsuario").value || "").trim().toUpperCase();
      const password = ($("inPass").value || "").trim();

      if(!usuario || !password){
        setMsg(msgLogin, "bad", "Ingresa usuario y contrase√±a.");
        return;
      }

      try{
        const qUser = query(
          collection(db, CONFIG.usuariosCollection),
          where("usuario","==", usuario),
          where("password","==", password),
          where("activo","==", true)
        );

        const snap = await getDocs(qUser);
        if(snap.empty){
          setMsg(msgLogin, "bad", "Usuario/contrase√±a incorrectos o usuario inactivo.");
          return;
        }

        const d = snap.docs[0];
        usuarioDocId = d.id;
        usuarioActual = d.data();

        pillUser.textContent = `${usuarioActual.nombre || usuarioActual.usuario || "Usuario"} ‚Ä¢ ${usuarioActual.rutaId || "SIN RUTA"}`;
        btnSalir.hidden = false;

        $("inSucursal").value = usuarioActual.rutaId || "";
        $("inFecha").value = nowStr();

        setMsg(msgLogin, "ok", "Acceso correcto.");
        await precargarProductos();
        showStep("buscar");

      }catch(err){
        console.error(err);
        setMsg(msgLogin, "bad", "Error validando usuario. Revisa consola.");
      }
    }

    btnSalir.addEventListener("click", ()=>{
      // "logout" local
      usuarioActual = null;
      usuarioDocId = null;
      productosCache = [];
      devolucionItems = [];
      renderTabla();
      pillUser.textContent = "No autenticado";
      btnSalir.hidden = true;

      $("inUsuario").value = "";
      $("inPass").value = "";
      $("inBuscar").value = "";
      $("resultados").innerHTML = "";
      setMsg(msgBuscar,"","");
      setMsg(msgTabla,"","");
      setMsg(msgResumen,"","");
      setMsg(msgFirma,"","");

      limpiarFirma();
      showStep("login");
    });

    // ==========================================================
    // Productos (cargar a cache)
    // ==========================================================
    async function precargarProductos(){
      setMsg(msgBuscar, "info", "Cargando cat√°logo de productos...");

      productosCache = [];
      try{
        let qProd;
        if(CONFIG.productosCampoActivo){
          qProd = query(
            collection(db, CONFIG.productosCollection),
            where(CONFIG.productosCampoActivo, "==", true)
          );
        }else{
          qProd = query(collection(db, CONFIG.productosCollection));
        }

        const snap = await getDocs(qProd);

        snap.forEach(docu=>{
          const p = docu.data();
          const codigo = (p[CONFIG.productosCampoCodigo] ?? "").toString();
          const desc = (p[CONFIG.productosCampoDesc] ?? "").toString();
          productosCache.push({
            id: docu.id,
            codigo,
            descripcion: desc
          });
        });

        setMsg(msgBuscar, "ok", `Productos cargados: ${productosCache.length}`);
      }catch(err){
        console.error(err);
        setMsg(msgBuscar, "bad", "No se pudo cargar productos. Revisa colecci√≥n/campos en CONFIG.");
      }
    }

    // ==========================================================
    // Buscar
    // ==========================================================
    $("btnBuscar").addEventListener("click", buscarRender);
    $("inBuscar").addEventListener("keydown", (e)=>{ if(e.key==="Enter") buscarRender(); });

    function buscarRender(){
      if(!requireLogin()) return;

      const txt = ($("inBuscar").value || "").trim();
      const out = $("resultados");
      out.innerHTML = "";

      if(!txt){
        setMsg(msgBuscar, "bad", "Escribe un c√≥digo o palabra para buscar.");
        return;
      }

      const t = norm(txt);
      const hits = productosCache.filter(p=>{
        return norm(p.codigo).includes(t) || norm(p.descripcion).includes(t);
      }).slice(0, 40);

      if(!hits.length){
        setMsg(msgBuscar, "bad", "Sin resultados.");
        return;
      }

      setMsg(msgBuscar, "ok", `Resultados: ${hits.length} (mostrando hasta 40).`);

      hits.forEach(p=>{
        const div = document.createElement("div");
        div.className = "resItem";
        div.innerHTML = `
          <div>
            <b>${p.codigo || "(sin c√≥digo)"}</b>
            <span>${p.descripcion || "(sin descripci√≥n)"}</span>
          </div>
          <div><button class="btn mini">Agregar</button></div>
        `;
        div.querySelector("button").addEventListener("click", ()=>agregarProducto(p));
        out.appendChild(div);
      });
    }

    // ==========================================================
    // Tabla: agregar / quitar / render
    // ==========================================================
    function agregarProducto(p){
      if(!requireLogin()) return;

      const cantStr = prompt(`Cantidad a devolver\n\n${p.codigo} - ${p.descripcion}`, "1");
      if(cantStr === null) return;

      const cant = safeInt(cantStr);
      if(!(cant > 0)){
        alert("Cantidad inv√°lida.");
        return;
      }

      const motivo = prompt("Motivo (ej: MERMA / CADUCIDAD / ERROR / OTRO)", "MERMA");
      if(motivo === null) return;

      devolucionItems.push({
        codigo: p.codigo,
        descripcion: p.descripcion,
        cantidad: cant,
        motivo: (motivo || "").trim() || "SIN MOTIVO"
      });

      renderTabla();
      showStep("tabla");
      setMsg(msgTabla, "ok", "Producto agregado.");
      setTimeout(()=>setMsg(msgTabla,"",""), 900);
    }

    function renderTabla(){
      const tb = $("tbodyDev");
      tb.innerHTML = "";

      if(!devolucionItems.length){
        tb.innerHTML = `<tr><td colspan="5" style="color:#6b7280">Sin productos agregados.</td></tr>`;
        $("totalesInfo").textContent = "0 productos";
        return;
      }

      devolucionItems.forEach((p, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.descripcion}</td>
          <td><b>${p.cantidad}</b></td>
          <td>${p.motivo}</td>
          <td class="t-actions"><button class="btn bad mini">Quitar</button></td>
        `;
        tr.querySelector("button").addEventListener("click", ()=>{
          devolucionItems.splice(idx,1);
          renderTabla();
        });
        tb.appendChild(tr);
      });

      const totalItems = devolucionItems.length;
      const totalCant = devolucionItems.reduce((acc,p)=>acc + safeInt(p.cantidad),0);
      $("totalesInfo").textContent = `${totalItems} productos ‚Ä¢ ${totalCant} piezas`;
    }

    // navegaci√≥n
    $("btnIrTabla").addEventListener("click", ()=>showStep("tabla"));
    $("btnVolverBuscar").addEventListener("click", ()=>showStep("buscar"));

    // ==========================================================
    // Resumen
    // ==========================================================
    $("btnContinuar").addEventListener("click", ()=>{
      if(!requireLogin()) return;

      if(!devolucionItems.length){
        setMsg(msgTabla, "bad", "Agrega al menos 1 producto.");
        return;
      }
      setMsg(msgTabla, "", "");

      $("outUsuario").value = usuarioActual?.nombre || usuarioActual?.usuario || "";
      $("outSucursal").value = usuarioActual?.rutaId || "";
      $("outFecha").value = nowStr();

      const tb = $("tbodyResumen");
      tb.innerHTML = "";
      devolucionItems.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.descripcion}</td>
          <td><b>${p.cantidad}</b></td>
          <td>${p.motivo}</td>
        `;
        tb.appendChild(tr);
      });

      showStep("resumen");
    });

    $("btnBackTabla").addEventListener("click", ()=>showStep("tabla"));
    $("btnFinalizar").addEventListener("click", ()=>showStep("firma"));
    $("btnBackResumen").addEventListener("click", ()=>showStep("resumen"));

    // ==========================================================
    // Firma (canvas)
    // ==========================================================
    const canvas = $("firmaCanvas");
    const ctx = canvas.getContext("2d");
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#111";

    let drawing = false;
    let last = null;

    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      let x, y;

      if(e.touches && e.touches.length){
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      }else{
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      }

      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return { x: x*scaleX, y: y*scaleY };
    }

    function startDraw(e){
      drawing = true;
      last = getPos(e);
      e.preventDefault?.();
    }
    function moveDraw(e){
      if(!drawing) return;
      const p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      last = p;
      e.preventDefault?.();
    }
    function endDraw(e){
      drawing = false;
      last = null;
      e.preventDefault?.();
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);

    canvas.addEventListener("touchstart", startDraw, {passive:false});
    canvas.addEventListener("touchmove", moveDraw, {passive:false});
    window.addEventListener("touchend", endDraw, {passive:false});

    $("btnLimpiarFirma").addEventListener("click", ()=>{
      limpiarFirma();
      setMsg(msgFirma, "info", "Firma limpiada.");
      setTimeout(()=>setMsg(msgFirma,"",""), 700);
    });

    function limpiarFirma(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function firmaVacia(){
      const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
      for(let i=3;i<pixels.length;i+=4){
        if(pixels[i] !== 0) return false;
      }
      return true;
    }

    // ==========================================================
    // Guardar + PDF
    // ==========================================================
    $("btnGuardar").addEventListener("click", async ()=>{
      if(!requireLogin()) return;

      if(!devolucionItems.length){
        setMsg(msgFirma, "bad", "No hay productos en la devoluci√≥n.");
        return;
      }
      if(firmaVacia()){
        setMsg(msgFirma, "bad", "La firma est√° vac√≠a.");
        return;
      }

      $("btnGuardar").disabled = true;
      setMsg(msgFirma, "info", "Guardando devoluci√≥n en Firebase...");

      try{
        const firmaBase64 = canvas.toDataURL("image/png");

        const payload = {
          estado: "finalizada",
          // datos usuario (desde usuarios_ruta)
          usuarioRutaDocId: usuarioDocId,
          usuario: usuarioActual.usuario || "",
          nombre: usuarioActual.nombre || "",
          rol: usuarioActual.rol || "",
          rutaId: usuarioActual.rutaId || "",

          fechaISO: new Date().toISOString(),
          fecha: serverTimestamp(),
          notas: ($("outNotas").value || "").trim(),

          productos: devolucionItems.map(p=>({
            codigo: p.codigo,
            descripcion: p.descripcion,
            cantidad: safeInt(p.cantidad),
            motivo: p.motivo
          })),

          firmaBase64
        };

        const ref = await addDoc(collection(db, CONFIG.devolucionesCollection), payload);
        const folio = ref.id;

        const pdfBlob = await generarPDF({ folio, payload });
        descargarBlob(pdfBlob, `devolucion_${folio}.pdf`);

        setMsg(msgFirma, "ok", `Guardado OK. Folio: ${folio}. PDF descargado.`);
      }catch(err){
        console.error(err);
        setMsg(msgFirma, "bad", "Error al guardar/generar PDF. Revisa consola.");
      }finally{
        $("btnGuardar").disabled = false;
      }
    });

    async function generarPDF({ folio, payload }){
      const { jsPDF } = window.jspdf;
      const docPDF = new jsPDF({ unit:"pt", format:"letter" });

      const margin = 40;
      let y = 52;

      docPDF.setFont("helvetica","bold");
      docPDF.setFontSize(16);
      docPDF.text("FORMATO DE DEVOLUCI√ìN", margin, y);

      docPDF.setFont("helvetica","normal");
      docPDF.setFontSize(11);
      y += 22;
      docPDF.text(`Folio: ${folio}`, margin, y);

      y += 16;
      docPDF.text(`Usuario: ${payload.nombre} (${payload.usuario})`, margin, y);
      y += 16;
      docPDF.text(`Ruta/Sucursal: ${payload.rutaId}`, margin, y);
      y += 16;
      docPDF.text(`Fecha: ${new Date(payload.fechaISO).toLocaleString("es-MX")}`, margin, y);

      if(payload.notas){
        y += 16;
        docPDF.text(`Notas: ${payload.notas}`, margin, y);
      }

      // Tabla
      y += 22;
      docPDF.setFont("helvetica","bold");
      docPDF.text("Productos:", margin, y);
      y += 12;

      const col = { c: margin, d: margin+120, q: margin+390, m: margin+460 };
      docPDF.setFontSize(10);

      y += 14;
      docPDF.setFont("helvetica","bold");
      docPDF.text("C√≥digo", col.c, y);
      docPDF.text("Descripci√≥n", col.d, y);
      docPDF.text("Cant.", col.q, y);
      docPDF.text("Motivo", col.m, y);

      docPDF.setLineWidth(0.6);
      docPDF.line(margin, y+6, 572, y+6);

      docPDF.setFont("helvetica","normal");
      y += 18;

      for(const p of payload.productos){
        if(y > 640){
          docPDF.addPage();
          y = 52;
        }
        docPDF.text((p.codigo||"").toString().slice(0,18), col.c, y);
        docPDF.text((p.descripcion||"").toString().slice(0,45), col.d, y);
        docPDF.text(String(p.cantidad||0), col.q, y);
        docPDF.text((p.motivo||"").toString().slice(0,20), col.m, y);
        y += 16;
      }

      // Firma
      if(y > 620){
        docPDF.addPage();
        y = 52;
      }

      y += 18;
      docPDF.setFont("helvetica","bold");
      docPDF.text("Firma:", margin, y);

      y += 10;
      docPDF.setDrawColor(0);
      docPDF.rect(margin, y, 260, 110);
      docPDF.addImage(payload.firmaBase64, "PNG", margin+10, y+10, 240, 90);

      y += 140;
      docPDF.setFont("helvetica","normal");
      docPDF.setFontSize(9);
      docPDF.text("Generado autom√°ticamente ‚Äì PROVSOFT", margin, y);

      return docPDF.output("blob");
    }

    function descargarBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    // ==========================================================
    // INIT
    // ==========================================================
    showStep("login");
    renderTabla();
  </script>
</body>
</html>
