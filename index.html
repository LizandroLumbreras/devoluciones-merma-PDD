<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formato de Devolución – PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:Poppins, Arial;
  background:linear-gradient(135deg,#00416A,#0c6cbd);
}
.wrap{max-width:1100px;margin:auto;padding:20px}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.15)
}
h1,h2{margin:0 0 10px;color:#00416A}
input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-family:inherit;
}
button{
  background:#00416A;
  color:white;
  cursor:pointer;
  border:none;
}
button.sec{background:#eee;color:#00416A}
button.ok{background:#1e8e3e}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;font-size:13px}
th{background:#f0f4f8;color:#00416A;text-align:left}
.results{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.resItem{
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
canvas{border:1px solid #ccc;border-radius:10px}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrap">

<h1 style="color:white">Formato de Devolución – PROVSOFT</h1>

<!-- LOGIN -->
<div class="card" id="step-login">
  <h2>Acceso</h2>
  <input id="inUsuario" placeholder="Usuario"><br><br>
  <input id="inPass" type="password" placeholder="Contraseña"><br><br>
  <button onclick="login()">Entrar</button>
  <div id="msgLogin"></div>
</div>

<!-- BUSCAR -->
<div class="card hidden" id="step-buscar">
  <h2>Buscar productos</h2>
  <input id="inBuscar" placeholder="Código o descripción">
  <button onclick="buscar()">Buscar</button>
  <div id="resultados" class="results"></div>
  <br>
  <button class="sec" onclick="show('tabla')">Ver tabla</button>
</div>

<!-- TABLA -->
<div class="card hidden" id="step-tabla">
  <h2>Productos a devolver</h2>
  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Descripción</th>
        <th>Cant.</th>
        <th>Motivo</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbodyDev"></tbody>
  </table>
  <br>
  <button class="sec" onclick="show('buscar')">Volver</button>
  <button class="ok" onclick="resumen()">Continuar</button>
</div>

<!-- RESUMEN -->
<div class="card hidden" id="step-resumen">
  <h2>Resumen</h2>
  <div id="infoResumen"></div>
  <table>
    <thead>
      <tr>
        <th>Código</th><th>Descripción</th><th>Cant.</th><th>Motivo</th>
      </tr>
    </thead>
    <tbody id="tbodyResumen"></tbody>
  </table>
  <br>
  <button class="sec" onclick="show('tabla')">Regresar</button>
  <button class="ok" onclick="show('firma')">Finalizar</button>
</div>

<!-- FIRMA -->
<div class="card hidden" id="step-firma">
  <h2>Firma</h2>
  <canvas id="firma" width="600" height="200"></canvas><br><br>
  <button class="sec" onclick="limpiarFirma()">Limpiar</button>
  <button class="ok" onclick="guardar()">Guardar y descargar PDF</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let usuario = null;
let productos = [];
let carrito = [];

window.show = s=>{
  document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
  document.getElementById("step-"+s).classList.remove("hidden");
};

window.login = async ()=>{
  const u = inUsuario.value.toUpperCase();
  const p = inPass.value;
  const q = query(collection(db,"usuarios_ruta"),
    where("usuario","==",u),
    where("password","==",p),
    where("activo","==",true)
  );
  const s = await getDocs(q);
  if(s.empty){ msgLogin.textContent="Acceso inválido"; return;}
  usuario = s.docs[0].data();
  await cargarProductos();
  show("buscar");
};

async function cargarProductos(){
  productos=[];
  const snap = await getDocs(collection(db,"productos"));
  snap.forEach(d=>{
    const p=d.data();
    productos.push({
      codigo:p.codigoBarra,
      desc:p.concepto || p.nombre || "(sin descripción)"
    });
  });
}

window.buscar = ()=>{
  resultados.innerHTML="";
  const t=inBuscar.value.toLowerCase();
  productos.filter(p=>p.codigo.includes(t)||p.desc.toLowerCase().includes(t))
    .slice(0,40)
    .forEach(p=>{
      const div=document.createElement("div");
      div.className="resItem";
      div.innerHTML=`<div><b>${p.codigo}</b><br>${p.desc}</div>
      <button>Agregar</button>`;
      div.querySelector("button").onclick=()=>agregar(p);
      resultados.appendChild(div);
    });
};

function agregar(p){
  const c=+prompt("Cantidad",1);
  const m=prompt("Motivo","MERMA");
  carrito.push({...p,cantidad:c,motivo:m});
  renderTabla();
  show("tabla");
}

function renderTabla(){
  tbodyDev.innerHTML="";
  carrito.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.codigo}</td><td>${p.desc}</td><td>${p.cantidad}</td><td>${p.motivo}</td>
    <td><button onclick="carrito.splice(${i},1);renderTabla()">X</button></td>`;
    tbodyDev.appendChild(tr);
  });
}

window.resumen=()=>{
  infoResumen.innerHTML=`<b>${usuario.nombre}</b> – ${usuario.rutaId}<br>${new Date().toLocaleString()}`;
  tbodyResumen.innerHTML="";
  carrito.forEach(p=>{
    tbodyResumen.innerHTML+=`<tr><td>${p.codigo}</td><td>${p.desc}</td><td>${p.cantidad}</td><td>${p.motivo}</td></tr>`;
  });
  show("resumen");
};

/* FIRMA */
const ctx=firma.getContext("2d");
let d=false;
firma.onmousedown=e=>{d=true;ctx.moveTo(e.offsetX,e.offsetY)};
firma.onmousemove=e=>{if(d){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke()}};
window.onmouseup=()=>d=false;
window.limpiarFirma=()=>ctx.clearRect(0,0,600,200);

/* GUARDAR + PDF PRO */
window.guardar=async()=>{
  const data={
    usuario:usuario.nombre,
    ruta:usuario.rutaId,
    fecha:new Date(),
    productos:carrito,
    firma:firma.toDataURL(),
    creado:serverTimestamp()
  };
  const ref=await addDoc(collection(db,"devoluciones"),data);
  generarPDF(ref.id,data);
};

function generarPDF(folio,payload){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF("p","pt","letter");
  const W=doc.internal.pageSize.width;
  const H=doc.internal.pageSize.height;

  doc.setFillColor(0,65,106);
  doc.rect(0,0,W,90,"F");
  doc.setTextColor(255);
  doc.setFontSize(18);
  doc.text("PROVSOFT",40,40);
  doc.setFontSize(12);
  doc.text("FORMATO DE DEVOLUCIÓN",40,60);
  doc.text("Folio: "+folio,W-40,40,{align:"right"});
  doc.setTextColor(0);

  let y=120;
  doc.setFontSize(11);
  doc.text("Usuario: "+payload.usuario,40,y);
  doc.text("Ruta: "+payload.ruta,300,y);
  y+=30;

  doc.setFont("helvetica","bold");
  doc.text("Productos devueltos",40,y);
  y+=14;

  doc.setFont("helvetica","normal");
  payload.productos.forEach(p=>{
    const lines=doc.splitTextToSize(p.desc,260);
    if(y+lines.length*14>H-160){doc.addPage();y=60;}
    doc.text(p.codigo,40,y);
    doc.text(lines,120,y);
    doc.text(String(p.cantidad),420,y);
    doc.text(p.motivo,460,y);
    y+=lines.length*14+6;
  });

  if(y>H-200){doc.addPage();y=60;}
  doc.text("Firma:",40,y+20);
  doc.rect(40,y+30,300,120);
  doc.addImage(payload.firma,"PNG",50,y+40,280,100);

  doc.save("devolucion_"+folio+".pdf");
}
</script>
</body>
</html>
